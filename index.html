<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Car Simulator with Firetruck Cutscene</title>
  <style>
    body { margin:0; overflow:hidden; background:#101418; }
    #hud {
      position:absolute; top:12px; left:12px; color:#e8f0ff; font-family:sans-serif;
      background:rgba(0,0,0,0.35); padding:8px 12px; border-radius:8px; z-index:10;
    }
    #banner {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      background:rgba(0,0,0,0.7); color:#fff; padding:12px 16px; border-radius:8px;
      font-family:sans-serif; display:none; z-index:20;
    }
  </style>
</head>
<body>
  <div id="hud"><b>Controls:</b> ↑ accelerate, ↓ brake, ←/→ steer, R reset</div>
  <div id="banner">Crash! Firefighters arriving...</div>

  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script>
    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 2000);

    // Lights
    scene.add(new THREE.HemisphereLight(0xffffff,0x202020,0.9));
    const dir = new THREE.DirectionalLight(0xffffff,0.8);
    dir.position.set(10,20,10);
    scene.add(dir);

    // Sky & sun
    const sky = new THREE.Mesh(new THREE.SphereGeometry(1000,32,32),
      new THREE.MeshBasicMaterial({color:0x87ceeb, side:THREE.BackSide}));
    scene.add(sky);
    const sun = new THREE.Mesh(new THREE.SphereGeometry(30,32,32),
      new THREE.MeshBasicMaterial({color:0xffd700}));
    sun.position.set(200,300,-400);
    scene.add(sun);

    // Grass ground
    const grass = new THREE.Mesh(new THREE.PlaneGeometry(2000,2000),
      new THREE.MeshStandardMaterial({color:0x228b22}));
    grass.rotation.x = -Math.PI/2;
    scene.add(grass);

    // Road
    const road = new THREE.Mesh(new THREE.PlaneGeometry(2000,20),
      new THREE.MeshStandardMaterial({color:0x333333}));
    road.rotation.x = -Math.PI/2;
    road.position.y = 0.01;
    scene.add(road);

    // Lane markings
    const laneMat = new THREE.MeshBasicMaterial({color:0xffffff});
    for(let i=-2;i<=2;i++){
      const lane = new THREE.Mesh(new THREE.PlaneGeometry(2000,0.2), laneMat);
      lane.rotation.x = -Math.PI/2;
      lane.position.z = i*4;
      lane.position.y = 0.02;
      scene.add(lane);
    }

    // Player car
    function buildCar(color=0x3a8cff){
      const car = new THREE.Group();
      const body = new THREE.Mesh(new THREE.BoxGeometry(3.6,1.2,1.6),
        new THREE.MeshStandardMaterial({color}));
      body.position.y=0.8;
      car.add(body);
      const cabin = new THREE.Mesh(new THREE.BoxGeometry(2.2,0.9,1.4),
        new THREE.MeshStandardMaterial({color:0x222a33,transparent:true,opacity:0.8}));
      cabin.position.set(0.2,1.25,0);
      car.add(cabin);
      const wheelGeo = new THREE.CylinderGeometry(0.4,0.4,0.25,16);
      wheelGeo.rotateZ(Math.PI/2);
      const tireMat = new THREE.MeshStandardMaterial({color:0x111111});
      [[1.2,0.35,0.75],[1.2,0.35,-0.75],[-1.2,0.35,0.75],[-1.2,0.35,-0.75]].forEach(([x,y,z])=>{
        const w = new THREE.Mesh(wheelGeo,tireMat); w.position.set(x,y,z); car.add(w);
      });
      return car;
    }
    const player = buildCar();
    scene.add(player);

    // Firetruck
    function buildFireTruck(){
      const g = new THREE.Group();
      const body = new THREE.Mesh(new THREE.BoxGeometry(6,2,2.5),
        new THREE.MeshStandardMaterial({color:0xcc0000}));
      body.position.y=1;
      g.add(body);
      const cab = new THREE.Mesh(new THREE.BoxGeometry(2,1.5,2),
        new THREE.MeshStandardMaterial({color:0x990000}));
      cab.position.set(2,1.5,0);
      g.add(cab);
      return g;
    }
    const fireTrucks=[];

    // Controls
    let speed=0,steer=0;
    const keys={ArrowUp:false,ArrowDown:false,ArrowLeft:false,ArrowRight:false,KeyR:false};
    window.addEventListener('keydown',e=>{if(keys.hasOwnProperty(e.code)) keys[e.code]=true;});
    window.addEventListener('keyup',e=>{if(keys.hasOwnProperty(e.code)) keys[e.code]=false;});

    function resetPlayer(){
      player.position.set(0,0,0);
      player.rotation.set(0,0,0);
      speed=0; steer=0;
    }
    resetPlayer();

    // Crash cutscene
    let crashed=false;
    function triggerCrash(){
      crashed=true;
      document.getElementById('banner').style.display='block';
      // spawn firetrucks
      for(let i=0;i<2;i++){
        const ft=buildFireTruck();
        ft.position.set(-50*(i+1),0,player.position.z+20);
        scene.add(ft);
        fireTrucks.push(ft);
      }
    }

    // Animate
    let last=performance.now();
    function animate(now){
      const dt=Math.min((now-last)/1000,0.05);
      last=now;

      if(!crashed){
        if(keys.ArrowUp) speed+=12*dt;
        else if(keys.ArrowDown) speed-=18*dt;
        else speed=Math.max(0,speed-6*dt);
        speed=Math.min(speed,22);

        if(keys.ArrowLeft) steer+=1.6*dt;
        if(keys.ArrowRight) steer-=1.6*dt;
        const yaw=steer*(speed/22)*0.8;
        player.rotation.y+=yaw*dt;

        const forward=new THREE.Vector3(1,0,0).applyQuaternion(player.quaternion);
        player.position.add(forward.multiplyScalar(speed*dt));

        if(keys.KeyR) resetPlayer();

        // Simple crash trigger: if car goes too far
        if(player.position.x>50) triggerCrash();
      } else {
        // Move firetrucks toward player
        fireTrucks.forEach(ft=>{
          const dir=new THREE.Vector3().subVectors(player.position,ft.position).normalize();
          ft.position.add(dir.multiplyScalar(10*dt));
        });
      }

      // Camera follow
      const offset=new THREE.Vector3(-8,4,15);
      const worldPos=offset.clone().applyMatrix4(player.matrixWorld);
      camera.position.copy(worldPos);
      camera.lookAt(player.position);

      renderer.render(scene,camera);
      requestAnimationFrame(animate);
    }
    animate();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Car Simulator — Endless City + Mobile Joystick</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html,body{margin:0;height:100%;overflow:hidden;background:#87ceeb}
#hud{position:absolute;top:12px;left:12px;color:#fff;font-family:system-ui;background:rgba(0,0,0,.35);padding:10px 12px;border-radius:8px;z-index:10}
#hud b{color:#ffd700;}
#speed{margin-top:6px}
/* Mobile joystick */
#joystick{position:absolute;bottom:20px;left:20px;width:120px;height:120px;background:rgba(0,0,0,.25);border-radius:50%;touch-action:none;z-index:20}
#stick{position:absolute;left:40px;top:40px;width:40px;height:40px;background:#fff;border-radius:50%;opacity:.9}
</style>
</head>
<body>
<div id="hud">
  <div><b>Controls:</b> Arrow keys to drive (↑ accelerate, ↓ brake/reverse, ←/→ steer), R to reset</div>
  <div id="speed">Speed: 0 km/h</div>
</div>

<div id="joystick"><div id="stick"></div></div>

<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

<script>
/* ================= SCENE ================= */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);
const camera = new THREE.PerspectiveCamera(70,innerWidth/innerHeight,.1,3000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);

/* ================= LIGHT ================= */
scene.add(new THREE.HemisphereLight(0xffffff,0x444444,.7));
const sun = new THREE.DirectionalLight(0xffffff,.9);
sun.position.set(100,120,60);
sun.castShadow=true;
scene.add(sun);
/* Sun sphere */
const sunMesh = new THREE.Mesh(
  new THREE.SphereGeometry(20,32,32),
  new THREE.MeshBasicMaterial({color:0xffeb3b})
);
sunMesh.position.set(100,150,-200);
scene.add(sunMesh);

/* ================= ROAD (ENDLESS LOOP + CURVE) ================= */
const roadSegments=[];
const roadMat=new THREE.MeshStandardMaterial({color:0x2a2f36});
const roadGeo=new THREE.PlaneGeometry(200,20);
for(let i=0;i<30;i++){
  const r=new THREE.Mesh(roadGeo,roadMat);
  r.rotation.x=-Math.PI/2;
  r.position.x=i*20;
  scene.add(r);
  roadSegments.push(r);
}

/* ================= ENVIRONMENT ================= */
function house(x,z){const h=new THREE.Mesh(new THREE.BoxGeometry(12,10,12),new THREE.MeshStandardMaterial({color:0xffcc80}));h.position.set(x,5,z);scene.add(h);}
function office(x,z){const b=new THREE.Mesh(new THREE.BoxGeometry(18,25,18),new THREE.MeshStandardMaterial({color:0x90caf9}));b.position.set(x,12,z);scene.add(b);}
function tree(x,z){const t=new THREE.Mesh(new THREE.ConeGeometry(3,10,8),new THREE.MeshStandardMaterial({color:0x2e7d32}));t.position.set(x,5,z);scene.add(t);}
function mountain(x,z){const m=new THREE.Mesh(new THREE.ConeGeometry(60,120,12),new THREE.MeshStandardMaterial({color:0x757575}));m.position.set(x,60,z);scene.add(m);}
for(let i=0;i<40;i++){house(i*40,-60);office(i*60,60);tree(i*30,-30);}
for(let i=0;i<10;i++)mountain(i*300,-300);

/* ================= CAR BUILDERS ================= */
function buildHyundaiI10(color=0x3a8cff){
  const car=new THREE.Group();
  const body=new THREE.Mesh(new THREE.BoxGeometry(3.6,1.2,1.6),new THREE.MeshStandardMaterial({color,metalness:0.1,roughness:0.6}));
  body.castShadow=true; body.position.y=0.8; car.add(body);
  const cabin=new THREE.Mesh(new THREE.BoxGeometry(2.2,0.9,1.4),new THREE.MeshStandardMaterial({color:0x222a33,transparent:true,opacity:0.85}));
  cabin.position.set(0.2,1.25,0); cabin.castShadow=true; car.add(cabin);
  const wheelGeo=new THREE.CylinderGeometry(0.35,0.35,0.25,16); wheelGeo.rotateZ(Math.PI/2);
  const wheelMat=new THREE.MeshStandardMaterial({color:0x111111});
  [[1.2,0.35,0.75],[1.2,0.35,-0.75],[-1.2,0.35,0.75],[-1.2,0.35,-0.75]].forEach(([x,y,z])=>{const w=new THREE.Mesh(wheelGeo,wheelMat);w.position.set(x,y,z);w.castShadow=true;car.add(w);});
  const hlMat=new THREE.MeshStandardMaterial({color:0xf5f5f5,emissive:0x222222,emissiveIntensity:.6});
  const hlL=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,0.2),hlMat);
  const hlR=hlL.clone(); hlL.position.set(1.9,1.0,0.45); hlR.position.set(1.9,1.0,-0.45); car.add(hlL,hlR);
  const plate=new THREE.Mesh(new THREE.BoxGeometry(0.8,0.15,0.02),new THREE.MeshStandardMaterial({color:0xffffff}));
  plate.position.set(-1.9,0.9,0); car.add(plate);
  return car;
}
function buildToyotaInnova(color=0xd14f3f){
  const car=new THREE.Group();
  const body=new THREE.Mesh(new THREE.BoxGeometry(4.6,1.4,1.9),new THREE.MeshStandardMaterial({color,metalness:0.15,roughness:0.55}));
  body.castShadow=true; body.position.y=0.9; car.add(body);
  const cabin=new THREE.Mesh(new THREE.BoxGeometry(2.8,1.1,1.7),new THREE.MeshStandardMaterial({color:0x1f252d,transparent:true,opacity:0.85}));
  cabin.position.set(0.3,1.4,0); cabin.castShadow=true; car.add(cabin);
  const wheelGeo=new THREE.CylinderGeometry(0.42,0.42,0.28,16); wheelGeo.rotateZ(Math.PI/2);
  const wheelMat=new THREE.MeshStandardMaterial({color:0x111111});
  [[1.6,0.42,0.9],[1.6,0.42,-0.9],[-1.6,0.42,0.9],[-1.6,0.42,-0.9]].forEach(([x,y,z])=>{const w=new THREE.Mesh(wheelGeo,wheelMat);w.position.set(x,y,z);w.castShadow=true;car.add(w);});
  const hlMat=new THREE.MeshStandardMaterial({color:0xf5f5f5,emissive:0x222222,emissiveIntensity:.6});
  const hlL=new THREE.Mesh(new THREE.BoxGeometry(0.25,0.25,0.25),hlMat);
  const hlR=hlL.clone(); hlL.position.set(2.3,1.2,0.55); hlR.position.set(2.3,1.2,-0.55); car.add(hlL,hlR);
  return car;
}

/* ================= PLAYER ================= */
const player=buildHyundaiI10();
scene.add(player);
let speed=0,steer=0;
const maxSpeed=22,accel=12,brakeAccel=18,friction=6,steerRate=1.6,steerDecay=2.5;
const keys={ArrowUp:false,ArrowDown:false,ArrowLeft:false,ArrowRight:false,KeyR:false};
window.addEventListener('keydown',e=>{if(keys.hasOwnProperty(e.code))keys[e.code]=true;});
window.addEventListener('keyup',e=>{if(keys.hasOwnProperty(e.code))keys[e.code]=false;});

/* ================= TRAFFIC ================= */
const traffic=[];
const colorsI10=[0xff5252,0x4caf50,0xffc107,0x9c27b0,0x03a9f4];
const colorsInnova=[0x607d8b,0xd14f3f,0x8bc34a,0x795548];
for(let i=0;i<6;i++){
  const car=(i%2===0)?buildHyundaiI10(colorsI10[i%colorsI10.length]):buildToyotaInnova(colorsInnova[i%colorsInnova.length]);
  const laneZ=[-6,0,6][i%3];
  car.position.set(-200+i*80,0,laneZ+Math.random()*1-0.5);
  car.userData={speed:8+Math.random()*10,laneZ,type:(i%2===0)?'i10':'innova'};
  scene.add(car); traffic.push(car);
}

/* ================= CAMERA ================= */
const driverOffset=new THREE.Vector3(0.3,1.35,0.35);
function updateCameraFromDriverSeat(){
  const worldPos=new THREE.Vector3();
  player.updateMatrixWorld();
  worldPos.copy(driverOffset).applyMatrix4(player.matrixWorld);
  camera.position.copy(worldPos);
  const forward=new THREE.Vector3(1,0.2,0).applyQuaternion(player.quaternion);
  camera.lookAt(worldPos.clone().add(forward.multiplyScalar(5)));
}

/* ================= MOBILE JOYSTICK ================= */
const joy=document.getElementById("joystick");
const stick=document.getElementById("stick");
let joyActive=false;
joy.addEventListener("pointerdown",()=>joyActive=true);
joy.addEventListener("pointerup",()=>{joyActive=false;stick.style.left="40px";stick.style.top="40px";});
joy.addEventListener("pointermove",e=>{
  if(!joyActive)return;
  const r=joy.getBoundingClientRect();
  let x=e.clientX-r.left-60; let y=e.clientY-r.top-60;
  x=Math.max(-40,Math.min(40,x)); y=Math.max(-40,Math.min(40,y));
  stick.style.left=40+x+"px"; stick.style.top=40+y+"px";
  steer=-x/40;
  if(y<0)speed+=accel*0.02;
  else speed-=brakeAccel*0.02;
});

/* ================= MAIN LOOP ================= */
const speedEl=document.getElementById("speed");
let last=performance.now();
function animate(now){
  const dt=Math.min((now-last)/1000,0.05); last=now;

  /* Keyboard input */
  if(keys.ArrowUp)speed+=accel*dt;
  if(keys.ArrowDown)speed-=brakeAccel*dt;
  if(keys.ArrowLeft)steer+=steerRate*dt;
  if(keys.ArrowRight)steer-=steerRate*dt;
  if(!keys.ArrowLeft&&!keys.ArrowRight){
    if(steer>0)steer=Math.max(0,steer-steerDecay*dt);
    else if(steer<0)steer=Math.min(0,steer+steerDecay*dt);
  }
  speed=THREE.MathUtils.clamp(speed,-8,maxSpeed);

  player.rotation.y+=steer*(speed/maxSpeed)*0.8*dt;
  const forward=new THREE.Vector3(1,0,0).applyQuaternion(player.quaternion);
  player.position.add(forward.multiplyScalar(speed*dt));
  player.position.z=THREE.MathUtils.clamp(player.position.z,-10,10);
  if(keys.KeyR){player.position.set(0,0,0);player.rotation.set(0,0,0);speed=0;steer=0;}

  updateCameraFromDriverSeat();

  /* Traffic movement */
  traffic.forEach(car=>{
    car.position.x+=car.userData.speed*dt;
    if(car.position.x>900){car.position.x=-900; car.userData.speed=8+Math.random()*10;}
    car.position.z+=(car.userData.laneZ-car.position.z)*0.02;
  });

  /* Endless road curvature */
  roadSegments.forEach(r=>{
    if(r.position.x+20<player.position.x) r.position.x+=roadSegments.length*20;
    r.position.z=Math.sin(r.position.x*0.01)*10;
  });

  speedEl.textContent=Math.round(Math.abs(speed)*3.6);
  renderer.render(scene,camera);
  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

/* ================= RESIZE ================= */
window.addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>

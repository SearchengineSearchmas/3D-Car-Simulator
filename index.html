<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Car Simulator</title>
  <style>
    body { margin:0; overflow:hidden; background:#101418; }
    #hud {
      position:absolute; top:12px; left:12px; color:#e8f0ff; font-family:sans-serif;
      background:rgba(0,0,0,0.35); padding:8px 12px; border-radius:8px; z-index:10;
    }
    #joystick {
      position:absolute; bottom:40px; left:40px; width:120px; height:120px;
      background:rgba(255,255,255,0.1); border:2px solid #aaa; border-radius:50%;
      touch-action:none; z-index:20;
    }
    #stick {
      position:absolute; width:60px; height:60px; background:rgba(255,255,255,0.4);
      border-radius:50%; left:30px; top:30px;
    }
  </style>
</head>
<body>
  <div id="hud">Speed: <span id="speed">0</span> km/h</div>
  <div id="joystick"><div id="stick"></div></div>

  <!-- Sounds -->
  <audio id="engineSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_3f9f1b.mp3?filename=car-engine-loop-10859.mp3" loop></audio>
  <audio id="fireSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_1f9f1b.mp3?filename=fire-burning-10860.mp3"></audio>

  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script>
    // Renderer
    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Scene & camera
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 2000);

    // Lights
    scene.add(new THREE.HemisphereLight(0xffffff,0x202020,0.9));
    const dir = new THREE.DirectionalLight(0xffffff,0.8);
    dir.position.set(10,20,10);
    scene.add(dir);

    // Sky & sun
    const sky = new THREE.Mesh(new THREE.SphereGeometry(1000,32,32),
      new THREE.MeshBasicMaterial({color:0x87ceeb, side:THREE.BackSide}));
    scene.add(sky);
    const sun = new THREE.Mesh(new THREE.SphereGeometry(30,32,32),
      new THREE.MeshBasicMaterial({color:0xffd700}));
    sun.position.set(200,300,-400);
    scene.add(sun);

    // Grass ground
    const grass = new THREE.Mesh(new THREE.PlaneGeometry(2000,2000),
      new THREE.MeshStandardMaterial({color:0x228b22}));
    grass.rotation.x = -Math.PI/2;
    scene.add(grass);

    // Road
    const road = new THREE.Mesh(new THREE.PlaneGeometry(2000,20),
      new THREE.MeshStandardMaterial({color:0x333333}));
    road.rotation.x = -Math.PI/2;
    road.position.y = 0.01;
    scene.add(road);

    // Lane markings
    const laneMat = new THREE.MeshBasicMaterial({color:0xffffff});
    for(let i=-2;i<=2;i++){
      const lane = new THREE.Mesh(new THREE.PlaneGeometry(2000,0.2), laneMat);
      lane.rotation.x = -Math.PI/2;
      lane.position.z = i*4;
      lane.position.y = 0.02;
      scene.add(lane);
    }

    // Trees & houses
    function addTree(x,z){
      const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.5,6,12),
        new THREE.MeshStandardMaterial({color:0x8b5a2b}));
      trunk.position.set(x,3,z);
      const crown = new THREE.Mesh(new THREE.SphereGeometry(3,16,12),
        new THREE.MeshStandardMaterial({color:0x2e7d32}));
      crown.position.set(x,8,z);
      scene.add(trunk,crown);
    }
    for(let i=0;i<10;i++){ addTree(-30,i*40-200); addTree(30,i*40-200); }

    function addHouse(x,z){
      const base = new THREE.Mesh(new THREE.BoxGeometry(12,8,12),
        new THREE.MeshStandardMaterial({color:0xcccccc}));
      base.position.set(x,4,z);
      const roof = new THREE.Mesh(new THREE.ConeGeometry(8,4,4),
        new THREE.MeshStandardMaterial({color:0x8b0000}));
      roof.position.set(x,10,z);
      scene.add(base,roof);
    }
    for(let i=0;i<5;i++){ addHouse(-60,i*80-200); addHouse(60,i*80-200); }

    // Player car
    function buildCar(color=0x3a8cff){
      const car = new THREE.Group();
      const body = new THREE.Mesh(new THREE.BoxGeometry(3.6,1.2,1.6),
        new THREE.MeshStandardMaterial({color}));
      body.position.y=0.8;
      car.add(body);
      const cabin = new THREE.Mesh(new THREE.BoxGeometry(2.2,0.9,1.4),
        new THREE.MeshStandardMaterial({color:0x222a33,transparent:true,opacity:0.8}));
      cabin.position.set(0.2,1.25,0);
      car.add(cabin);
      const wheelGeo = new THREE.CylinderGeometry(0.4,0.4,0.25,16);
      wheelGeo.rotateZ(Math.PI/2);
      const tireMat = new THREE.MeshStandardMaterial({color:0x111111});
      [[1.2,0.35,0.75],[1.2,0.35,-0.75],[-1.2,0.35,0.75],[-1.2,0.35,-0.75]].forEach(([x,y,z])=>{
        const w = new THREE.Mesh(wheelGeo,tireMat); w.position.set(x,y,z); car.add(w);
      });
      return car;
    }
    const player = buildCar();
    scene.add(player);

    // Traffic cars
    const traffic=[];
    for(let i=0;i<5;i++){
      const car=buildCar(0xff0000);
      car.position.set(i*40-100,0,(i%2===0)?4:-4);
      traffic.push(car);
      scene.add(car);
    }

    // Pedestrians
    function buildPerson(x,z){
      const head=new THREE.Mesh(new THREE.SphereGeometry(0.5,16,12),
        new THREE.MeshStandardMaterial({color:0xf2c7a5}));
      head.position.set(x,1.6,z);
      const body=new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,1.2,12),
        new THREE.MeshStandardMaterial({color:0x2f7df0}));
      body.position.set(x,0.6,z);
      scene.add(head,body);
      return {head,body};
    }
    const people=[buildPerson(0,10),buildPerson(5,-20)];

    // Traffic lights
    function addTrafficLight(x,z){
      const pole=new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.2,6,12),
        new THREE.MeshStandardMaterial({color:0x444444}));
      pole.position.set(x,3,z);
      scene.add(pole);
      const red=new THREE.Mesh(new THREE.SphereGeometry(0.5,16,12),
        new THREE.MeshStandardMaterial({color:0xaa0000}));
      red.position.set(x,5,z);
      const yellow=new THREE.Mesh(new THREE.SphereGeometry(0.5,16,12),
        new THREE.MeshStandardMaterial({color:0xaaaa00}));
      yellow.position.set(x,4,z);
      const green=new THREE.Mesh(new THREE.SphereGeometry(0.5,16,12),
        new THREE.MeshStandardMaterial({color:0

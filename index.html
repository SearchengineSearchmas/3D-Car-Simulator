<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>City Game + Jail Obby Escape</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
html,body{margin:0;overflow:hidden;background:#87ceeb;font-family:system-ui}
#joystick{position:absolute;bottom:20px;left:20px;width:120px;height:120px;
border-radius:50%;background:rgba(0,0,0,.25);z-index:10}
#stick{position:absolute;left:50%;top:50%;width:46px;height:46px;
border-radius:50%;background:#fff;transform:translate(-50%,-50%)}
#jumpBtn{position:absolute;bottom:30px;right:30px;width:80px;height:80px;
border-radius:50%;background:#ff5252;color:#fff;
display:flex;align-items:center;justify-content:center;
font-weight:700;font-size:18px;z-index:10}
#label{position:absolute;top:10px;left:10px;
background:rgba(0,0,0,.5);color:#fff;padding:8px;border-radius:6px;z-index:10}
</style>
</head>
<body>

<div id="label">Drive → Crash → Jail → Escape Obby</div>
<div id="joystick"><div id="stick"></div></div>
<div id="jumpBtn">JUMP</div>

<script src="https://unpkg.com/three@0.159.0/build/three.min.js"></script>
<script>
/* ---------- BASIC SETUP ---------- */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87ceeb);

const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,1000);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1));
const sun=new THREE.DirectionalLight(0xffffff,1);
sun.position.set(10,20,10);
scene.add(sun);

/* ---------- STATE ---------- */
const STATE={CITY:0,JAIL:1,OBBY:2};
let state=STATE.CITY;

/* ---------- GROUND ---------- */
const ground=new THREE.Mesh(
  new THREE.PlaneGeometry(200,200),
  new THREE.MeshStandardMaterial({color:0x4caf50})
);
ground.rotation.x=-Math.PI/2;
scene.add(ground);

/* ---------- PLAYER ---------- */
const player=new THREE.Mesh(
  new THREE.BoxGeometry(1,1.8,1),
  new THREE.MeshStandardMaterial({color:0x2196f3})
);
player.position.y=1;
scene.add(player);

let velY=0,onGround=false;

/* ---------- JAIL ---------- */
const jail=new THREE.Mesh(
  new THREE.BoxGeometry(12,6,12),
  new THREE.MeshStandardMaterial({color:0x9e9e9e})
);
jail.position.set(0,3,-30);
scene.add(jail);

/* ---------- OBBY ---------- */
const obbyPlatforms=[];
function platform(x,y,z){
  const p=new THREE.Mesh(
    new THREE.BoxGeometry(4,.5,4),
    new THREE.MeshStandardMaterial({color:0xff9800})
  );
  p.position.set(x,y,z);
  scene.add(p);
  obbyPlatforms.push(p);
}
for(let i=0;i<6;i++) platform(0,i*3,-60-i*6);

const exit=new THREE.Mesh(
  new THREE.BoxGeometry(4,4,1),
  new THREE.MeshStandardMaterial({color:0x4caf50})
);
exit.position.set(0,20,-100);
scene.add(exit);

/* ---------- JOYSTICK ---------- */
const stick=document.getElementById("stick");
let joy={x:0,y:0};

stick.onpointerdown=e=>stick.setPointerCapture(e.pointerId);
stick.onpointermove=e=>{
  if(!stick.hasPointerCapture(e.pointerId))return;
  joy.x=Math.max(-1,Math.min(1,e.offsetX/23-1));
  joy.y=Math.max(-1,Math.min(1,e.offsetY/23-1));
};
stick.onpointerup=()=>joy.x=joy.y=0;

/* ---------- JUMP ---------- */
const jumpBtn=document.getElementById("jumpBtn");
function jump(){
  if(onGround){velY=0.35;onGround=false;}
}
jumpBtn.onclick=jump;
addEventListener("keydown",e=>{
  if(e.code==="Space") jump();
});

/* ---------- ARREST → JAIL ---------- */
function goToJail(){
  state=STATE.JAIL;
  player.position.set(0,1,-28);
}

/* ---------- SECRET OBBY ---------- */
function enterObby(){
  state=STATE.OBBY;
  player.position.set(0,2,-58);
}

/* ---------- INPUT ---------- */
addEventListener("keydown",e=>{
  if(e.key==="ArrowLeft") joy.x=-1;
  if(e.key==="ArrowRight") joy.x=1;
  if(e.key==="ArrowUp") joy.y=1;
  if(e.key==="ArrowDown") joy.y=-1;
});
addEventListener("keyup",()=>joy.x=joy.y=0);

/* ---------- LOOP ---------- */
function animate(){
  requestAnimationFrame(animate);

  if(state!==STATE.CITY){
    velY-=0.02;
    player.position.y+=velY;
    if(player.position.y<1){player.position.y=1;velY=0;onGround=true;}
  }

  player.position.x+=joy.x*0.15;
  player.position.z-=joy.y*0.15;

  // Jail secret trigger
  if(state===STATE.JAIL && player.position.z<-32) enterObby();

  // Obby physics
  if(state===STATE.OBBY){
    onGround=false;
    for(const p of obbyPlatforms){
      if(Math.abs(player.position.x-p.position.x)<2 &&
         Math.abs(player.position.z-p.position.z)<2 &&
         player.position.y<=p.position.y+1){
           player.position.y=p.position.y+1;
           velY=0; onGround=true;
      }
    }
    if(player.position.y<0) player.position.set(0,2,-58);
    if(player.position.distanceTo(exit.position)<3){
      state=STATE.CITY;
      player.position.set(0,1,0);
    }
  }

  camera.position.set(
    player.position.x,
    player.position.y+6,
    player.position.z+10
  );
  camera.lookAt(player.position);

  renderer.render(scene,camera);
}
animate();

/* ---------- DEMO ARREST ---------- */
setTimeout(goToJail,4000); // demo: auto-arrest
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Car Simulator ‚Äì Police, Fire, Hospital & Prison</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html,body{margin:0;height:100%;overflow:hidden;background:#87ceeb;font-family:system-ui}
#hud{
position:absolute;top:12px;left:12px;z-index:10;
background:rgba(0,0,0,.45);color:#fff;
padding:10px 12px;border-radius:8px;font-size:14px
}
.overlay{
position:absolute;inset:0;display:none;
align-items:center;justify-content:center;
background:rgba(0,0,0,.75);
color:#fff;font-size:28px;
font-weight:700;z-index:30;text-align:center
}
#prisonTimer{font-size:18px;margin-top:10px}
#joystick{
position:absolute;bottom:20px;left:20px;
width:120px;height:120px;border-radius:50%;
background:rgba(0,0,0,.25);z-index:20
}
#stick{
position:absolute;left:50%;top:50%;
width:46px;height:46px;border-radius:50%;
background:#fff;transform:translate(-50%,-50%)
}
</style>
</head>
<body>

<div id="hud">
<b>Rules</b><br>
Red light = STOP<br>
Crash rules apply<br>
Speed: <span id="speed">0</span> km/h
</div>

<div id="crash" class="overlay">üöí CRASH<br>Firefighters arriving‚Ä¶</div>
<div id="npcArrest" class="overlay">üöì NPC ARRESTED</div>
<div id="hospital" class="overlay">üè• HOSPITAL<br>Being treated‚Ä¶</div>
<div id="busted" class="overlay">üöì BUSTED</div>
<div id="prison" class="overlay">
üèõ PRISON
<div id="prisonTimer"></div>
</div>

<div id="joystick"><div id="stick"></div></div>

<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script>
/* ================= STATES ================= */
const STATE={PLAY:0,CRASH:1,CHASE:2,PRISON:3,HOSPITAL:4};
let gameState=STATE.PLAY;

/* ================= SCENE ================= */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87ceeb);
scene.fog=new THREE.Fog(0x87ceeb,200,1400);

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);

const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,.1,3000);

/* ================= LIGHT ================= */
scene.add(new THREE.HemisphereLight(0xffffff,0x666666,.9));
const sun=new THREE.DirectionalLight(0xffffff,.9);
sun.position.set(200,300,100);sun.castShadow=true;
scene.add(sun);

/* ================= ROAD ================= */
const segments=[],SEG=120,COUNT=18;
const roadMat=new THREE.MeshStandardMaterial({color:0x2b2f36});
for(let i=0;i<COUNT;i++){
 const g=new THREE.Group();
 const r=new THREE.Mesh(new THREE.PlaneGeometry(SEG,18),roadMat);
 r.rotation.x=-Math.PI/2;r.receiveShadow=true;g.add(r);
 [-6,0,6].forEach(z=>{
  const l=new THREE.Mesh(
   new THREE.PlaneGeometry(SEG,.25),
   new THREE.MeshBasicMaterial({color:0xffffff})
  );
  l.rotation.x=-Math.PI/2;l.position.z=z;g.add(l);
 });
 g.position.x=i*SEG;
 scene.add(g);segments.push(g);
}

/* ================= CAR BUILDERS ================= */
function buildCar(color){
 const g=new THREE.Group();
 const body=new THREE.Mesh(
  new THREE.BoxGeometry(3.6,1.2,1.6),
  new THREE.MeshStandardMaterial({color})
 );
 body.position.y=.8;body.castShadow=true;g.add(body);
 return g;
}
function buildPoliceCar(){
 return buildCar(0x1e3cff);
}
function buildFireTruck(){
 return buildCar(0xff3b3b);
}

/* ================= PLAYER ================= */
const player=buildCar(0x3a8cff);
scene.add(player);

/* ================= TRAFFIC ================= */
const traffic=[];
for(let i=0;i<6;i++){
 const c=buildCar(Math.random()*0xffffff);
 c.position.set(-200+i*80,0,[-6,0,6][i%3]);
 c.userData.speed=6+Math.random()*8;
 scene.add(c);traffic.push(c);
}

/* ================= INPUT ================= */
let speed=0,steer=0;
const maxSpeed=22;
const keys={ArrowUp:0,ArrowDown:0,ArrowLeft:0,ArrowRight:0};
addEventListener("keydown",e=>keys[e.code]=1);
addEventListener("keyup",e=>keys[e.code]=0);

/* MOBILE JOYSTICK */
const joy=document.getElementById("joystick");
const stick=document.getElementById("stick");
let joyX=0,joyY=0,active=false;
joy.addEventListener("touchstart",()=>active=true);
joy.addEventListener("touchend",()=>{
 active=false;joyX=joyY=0;
 stick.style.transform="translate(-50%,-50%)";
});
joy.addEventListener("touchmove",e=>{
 if(!active)return;
 const r=joy.getBoundingClientRect();
 const t=e.touches[0];
 let x=t.clientX-(r.left+r.width/2);
 let y=t.clientY-(r.top+r.height/2);
 x=Math.max(-40,Math.min(40,x));
 y=Math.max(-40,Math.min(40,y));
 joyX=x/40;joyY=y/40;
 stick.style.transform=`translate(${x-23}px,${y-23}px)`;
});

/* ================= CAMERA ================= */
function updateCam(){
 const off=new THREE.Vector3(.3,1.3,.4).applyQuaternion(player.quaternion);
 camera.position.copy(player.position).add(off);
 camera.lookAt(player.position.clone().add(
  new THREE.Vector3(1,.2,0).applyQuaternion(player.quaternion).multiplyScalar(5)
 ));
}

/* ================= COLLISIONS ================= */
function box(o){return new THREE.Box3().setFromObject(o);}

function npcNpcCrash(){
 for(let i=0;i<traffic.length;i++)
  for(let j=i+1;j<traffic.length;j++)
   if(box(traffic[i]).intersectsBox(box(traffic[j])))
    return [traffic[i],traffic[j]];
 return null;
}

function npcPlayerCrash(){
 for(const c of traffic)
  if(box(player).intersectsBox(box(c))) return c;
 return null;
}

/* ================= HANDLERS ================= */
const overlays={
 crash:crash,
 npc:npcArrest,
 hospital:hospital,
 busted:busted,
 prison:prison
};

function show(o){o.style.display="flex";}
function hide(o){o.style.display="none";}

function handleNPCCrash(a,b){
 gameState=STATE.CRASH;
 show(npcArrest);
 const p=buildPoliceCar();
 p.position.copy(a.position).add(new THREE.Vector3(-6,0,0));
 scene.add(p);
 setTimeout(()=>{
  scene.remove(a);scene.remove(b);scene.remove(p);
  traffic.splice(traffic.indexOf(a),1);
  traffic.splice(traffic.indexOf(b),1);
  hide(npcArrest);
  gameState=STATE.PLAY;
 },3000);
}

function handleNPCPlayer(c){
 gameState=STATE.HOSPITAL;
 show(hospital);
 const p=buildPoliceCar();
 scene.add(p);
 setTimeout(()=>{
  scene.remove(c);scene.remove(p);
  traffic.splice(traffic.indexOf(c),1);
  hide(hospital);
  gameState=STATE.PLAY;
 },4000);
}

/* ================= LOOP ================= */
let last=performance.now();
function animate(now){
 const dt=Math.min((now-last)/1000,.05);last=now;
 if(gameState===STATE.PLAY){
  if(keys.ArrowUp||joyY<-0.3)speed+=12*dt;
  if(keys.ArrowDown||joyY>0.3)speed-=18*dt;
  speed=Math.max(-8,Math.min(maxSpeed,speed));
  if(keys.ArrowLeft||joyX<-0.3)steer+=1.6*dt;
  if(keys.ArrowRight||joyX>0.3)steer-=1.6*dt;
  steer*=.96;
  player.rotation.y+=steer*(speed/maxSpeed)*dt;
  player.position.add(new THREE.Vector3(1,0,0).applyQuaternion(player.quaternion).multiplyScalar(speed*dt));

  segments.forEach(s=>{
   if(s.position.x+SEG<player.position.x-SEG){
    s.position.x+=SEG*COUNT;
    s.position.z=Math.sin(s.position.x*.01)*4;
   }
  });

  traffic.forEach(c=>{
   c.position.x+=c.userData.speed*dt;
   if(c.position.x>player.position.x+600)c.position.x=player.position.x-600;
  });

  const nn=npcNpcCrash();
  if(nn)handleNPCCrash(nn[0],nn[1]);

  const np=npcPlayerCrash();
  if(np)handleNPCPlayer(np);

  updateCam();
 }

 document.getElementById("speed").textContent=Math.abs(speed*3.6|0);
 renderer.render(scene,camera);
 requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

addEventListener("resize",()=>{
 camera.aspect=innerWidth/innerHeight;
 camera.updateProjectionMatrix();
 renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Car Simulator — Traffic Crash Cutscene</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html,body{margin:0;height:100%;overflow:hidden;background:#87ceeb;font-family:system-ui}
#hud{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.45);color:#fff;padding:10px;border-radius:8px;z-index:10}
#joystick{position:absolute;bottom:20px;left:20px;width:120px;height:120px;border-radius:50%;background:rgba(0,0,0,.35);touch-action:none}
#stick{position:absolute;left:35px;top:35px;width:50px;height:50px;border-radius:50%;background:#9bd1ff}
#banner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
background:rgba(0,0,0,.7);color:#fff;padding:14px 18px;border-radius:10px;display:none;z-index:20}
</style>
</head>
<body>

<div id="hud">
<b>Controls:</b> Arrows / Joystick<br>
<span id="speed">Speed: 0 km/h</span>
</div>

<div id="banner">Crash detected — calling firefighters…</div>
<div id="joystick"><div id="stick"></div></div>

<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

<script>
/* SCENE */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87ceeb);

/* RENDERER */
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);

/* CAMERA */
const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,.1,2000);

/* LIGHTS */
scene.add(new THREE.HemisphereLight(0xffffff,0x444444,.7));
const sunLight=new THREE.DirectionalLight(0xffffff,.9);
sunLight.position.set(100,150,80);
sunLight.castShadow=true;
scene.add(sunLight);

/* SUN */
scene.add(new THREE.Mesh(
new THREE.SphereGeometry(12,32,32),
new THREE.MeshBasicMaterial({color:0xffdd33})
)).position.set(200,160,-300);

/* GROUND */
const grass=new THREE.Mesh(
new THREE.PlaneGeometry(4000,4000),
new THREE.MeshStandardMaterial({color:0x3fa34d})
);
grass.rotation.x=-Math.PI/2;
scene.add(grass);

/* RIVER */
const river=new THREE.Mesh(
new THREE.PlaneGeometry(4000,40),
new THREE.MeshStandardMaterial({color:0x3aa7ff})
);
river.rotation.x=-Math.PI/2;
river.position.set(0,.02,-80);
scene.add(river);

/* ROAD */
const roadSegments=[];
for(let i=0;i<20;i++){
const seg=new THREE.Mesh(
new THREE.PlaneGeometry(80,14),
new THREE.MeshStandardMaterial({color:0x2a2f36})
);
seg.rotation.x=-Math.PI/2;
seg.position.x=i*80;
seg.position.z=Math.sin(i*.3)*6;
scene.add(seg);
roadSegments.push(seg);
}

/* CAR BUILDER */
function buildCar(color){
const g=new THREE.Group();
const body=new THREE.Mesh(
new THREE.BoxGeometry(3.8,1.2,1.7),
new THREE.MeshStandardMaterial({color})
);
body.position.y=.8;
g.add(body);

const cabin=new THREE.Mesh(
new THREE.BoxGeometry(2.2,.9,1.4),
new THREE.MeshStandardMaterial({color:0x222a33,transparent:true,opacity:.85})
);
cabin.position.set(.3,1.25,0);
g.add(cabin);

return g;
}

/* PLAYER */
const player=buildCar(0x3a8cff);
scene.add(player);

/* TRAFFIC (LIMITED & SLOW) */
const traffic=[];
for(let i=0;i<3;i++){
const car=buildCar([0xff5252,0x4caf50,0xffc107][i]);
car.position.set(80+i*120,0,(i-1)*3);
car.userData.speed=2.2;
scene.add(car);
traffic.push(car);
}

/* DRIVER (CUTSCENE) */
function buildMan(){
const g=new THREE.Group();
const head=new THREE.Mesh(new THREE.SphereGeometry(.25),new THREE.MeshStandardMaterial({color:0xf2c7a5}));
head.position.y=1.7;
const body=new THREE.Mesh(new THREE.CylinderGeometry(.2,.2,.8),new THREE.MeshStandardMaterial({color:0x2f7df0}));
body.position.y=1.2;
g.add(head,body);
return g;
}
const man=buildMan();
man.visible=false;
scene.add(man);

/* INPUT */
let speed=0,steer=0;
const keys={up:false,down:false,left:false,right:false};
addEventListener("keydown",e=>{
if(e.code==="ArrowUp")keys.up=true;
if(e.code==="ArrowDown")keys.down=true;
if(e.code==="ArrowLeft")keys.left=true;
if(e.code==="ArrowRight")keys.right=true;
});
addEventListener("keyup",e=>{
if(e.code==="ArrowUp")keys.up=false;
if(e.code==="ArrowDown")keys.down=false;
if(e.code==="ArrowLeft")keys.left=false;
if(e.code==="ArrowRight")keys.right=false;
});

/* JOYSTICK */
const joy=document.getElementById("joystick");
const stick=document.getElementById("stick");
let active=false;
joy.addEventListener("touchstart",()=>active=true);
joy.addEventListener("touchend",()=>{
active=false;stick.style.left="35px";stick.style.top="35px";
Object.keys(keys).forEach(k=>keys[k]=false);
});
joy.addEventListener("touchmove",e=>{
if(!active)return;
const r=joy.getBoundingClientRect();
const dx=Math.max(-40,Math.min(40,e.touches[0].clientX-r.left-60));
const dy=Math.max(-40,Math.min(40,e.touches[0].clientY-r.top-60));
stick.style.left=35+dx+"px";
stick.style.top=35+dy+"px";
keys.left=dx<-15; keys.right=dx>15;
keys.up=dy<-15; keys.down=dy>15;
});

/* CRASH SYSTEM */
let state="play
